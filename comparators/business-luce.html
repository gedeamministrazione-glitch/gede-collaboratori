<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparatore Offerte Energia Elettrica Business</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f8f8f8; color: #333; line-height: 1.6; }
    h1 { text-align: center; color: #444; margin-bottom: 30px; }
    .input-section { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto; }
    .input-group { margin-bottom: 18px; }
    .input-group label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
    .input-group input[type="number"], .input-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
    button { display: block; width: 100%; background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; font-size: 1.1rem; margin-top: 20px; }
    button:hover { background-color: #0056b3; }
    .results-section { margin-top: 30px; background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); max-width: 800px; margin-left: auto; margin-right: auto; overflow-x: auto; }
    .results-section h2 { text-align: center; color: #007bff; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 600px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f2f2f2; font-weight: bold; color: #333; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #e9e9e9; }
    .print-button { display: block; width: auto; margin: 20px auto; padding: 10px 15px; background-color: #6c757d; border: none; color: white; border-radius: 5px; cursor: pointer; font-size: 1rem; text-align: center; }
    .print-button:hover { background-color: #5a6268; }
    .note { margin-top: 18px; font-size: 0.92em; color: #555; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:0.85rem; margin-left:6px; }
  </style>
</head>
<body>
  <h1>GEDE SERVIZI - Energia Elettrica Business</h1>

  <div class="input-section">
    <h2>Inserisci i tuoi dati di consumo</h2>

    <div class="input-group">
      <label for="consumo">Consumo mensile (kWh):</label>
      <input type="number" id="consumo" value="833" step="1" min="0">
    </div>

    <div class="input-group">
      <label for="pun">PUN Monorario (€/kWh) <span class="badge">puro</span>:</label>
      <input type="number" id="pun" value="0.12" step="0.001" min="0">
    </div>

    <div class="input-group">
      <label for="tensione">Tensione di fornitura:</label>
      <select id="tensione">
        <option value="BT" selected>BT - Bassa Tensione</option>
        <option value="MT">MT - Media Tensione</option>
      </select>
    </div>

    <p class="note">
      Nota: il PUN inserito è considerato <b>puro</b> (senza perdite).
      In BT applichiamo perdite <b>10%</b> (×1,10); in MT perdite <b>3,8%</b> (×1,038).
    </p>

    <button onclick="calcolaTutteLeOfferte()">Calcola Offerte</button>
  </div>

  <div class="results-section">
    <h2 id="results-title">Risultati Comparazione Mensile Stimata</h2>

    <h3 style="text-align:center; color:#007bff;">Offerte CEI &gt; 30.000 kWh</h3>
    <table id="tabella-cei-superiore">
      <thead>
        <tr>
          <th>Offerta</th>
          <th>Costo Materia Prima (€)</th>
          <th>Quota Fissa (€)</th>
          <th>Totale Stimato (€)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3 style="text-align:center; color:#007bff; margin-top:30px;">Offerte CEI &lt; 30.000 kWh</h3>
    <table id="tabella-cei-inferiore">
      <thead>
        <tr>
          <th>Offerta</th>
          <th>Costo Materia Prima (€)</th>
          <th>Quota Fissa (€)</th>
          <th>Totale Stimato (€)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3 style="text-align:center; color:#007bff; margin-top:30px;">Altre Offerte</h3>
    <table id="tabella-altre">
      <thead>
        <tr>
          <th>Offerta</th>
          <th>Costo Materia Prima (€)</th>
          <th>Quota Fissa (€)</th>
          <th>Totale Stimato (€)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="note">
      Nota: i totali stimati includono <b>solo</b> i costi di vendita su base mensile (Materia Prima e Quota Fissa),
      includendo perdite (BT/MT), dispacciamento e mercato capacità (valori di sistema).
      Sono esclusi IVA, imposte, costi di Rete e Oneri di Sistema ARERA.
    </p>
  </div>

  <button onclick="window.print()" class="print-button">Stampa Risultati</button>

  <script>
    /***************************************************************
     * COEFFICIENTI PERDITE (PUN PURO -> PUN "con perdite")
     * BT: 10% (x 1,10) | MT: 3,8% (x 1,038)
     ***************************************************************/
    const LOSS_MULTIPLIER = {
      BT: 1.10,
      MT: 1.038
    };

    /***************************************************************
     * DISPACCIAMENTO + MERCATO CAPACITÀ (valori copiati dalle CTE ESTRA)
     * Per ora li usiamo uguali in BT/MT per non “inventare” differenze.
     * Se in futuro vuoi differenziarli, cambia solo questi numeri.
     ***************************************************************/
    const DISP_KWH = {
      BT: 0.01078,
      MT: 0.01078
    };

    const CAPACITA_KWH = {
      BT: 0.009008,
      MT: 0.009008
    };

    // Estra: costo GO (da CTE)
    const ESTRA_GO_KWH = 0.011;

    const round2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;

    function resultRow(nome, costoMateriaPrima, quotaFissa) {
      const totale = costoMateriaPrima + quotaFissa;
      return {
        nome,
        costoMateriaPrima: round2(costoMateriaPrima).toFixed(2),
        quotaFissa: round2(quotaFissa).toFixed(2),
        totale: round2(totale).toFixed(2)
      };
    }

    function getTensione() {
      const t = document.getElementById('tensione').value;
      return (t === "MT") ? "MT" : "BT";
    }

    function prezzoIndicizzatoKwh(punPuro, spread, variabiliOfferta, tensione, includePerdite = true) {
      const loss = LOSS_MULTIPLIER[tensione] ?? LOSS_MULTIPLIER.BT;
      const punEff = includePerdite ? (punPuro * loss) : punPuro;

      const disp = DISP_KWH[tensione] ?? DISP_KWH.BT;
      const cap = CAPACITA_KWH[tensione] ?? CAPACITA_KWH.BT;

      return punEff + spread + variabiliOfferta + disp + cap;
    }

    /***************************************************************
     * CEI < 30.000 kWh
     ***************************************************************/
    function calcolaCeiReflex(consumo, pun, tensione) {
      const spread = 0.014;
      const quotaFissa = 26.5;
      const variabili = 0.002 + 0.0035 + 0.00219;
      const prezzoKwh = prezzoIndicizzatoKwh(pun, spread, variabili, tensione, true);
      return resultRow("CEI REFLEX (< 30.000 kWh)", prezzoKwh * consumo, quotaFissa);
    }

    function calcolaCanon(consumo, pun, tensione) {
      const spread = 0.012;
      const quotaFissa = 19.5;
      const variabili = 0.002 + 0.0035 + 0.00219;
      const prezzoKwh = prezzoIndicizzatoKwh(pun, spread, variabili, tensione, true);
      return resultRow("CEI CANON (< 30.000 kWh)", prezzoKwh * consumo, quotaFissa);
    }

    function calcolaVision(consumo, pun, tensione) {
      const spread = 0.012;
      const quotaFissa = 16.0;
      const variabili = 0.002 + 0.0035;
      const prezzoKwh = prezzoIndicizzatoKwh(pun, spread, variabili, tensione, true);
      return resultRow("CEI VISION (< 30.000 kWh)", prezzoKwh * consumo, quotaFissa);
    }

    /***************************************************************
     * CEI > 30.000 kWh
     ***************************************************************/
    function calcolaCeiPartner(consumo, pun, tensione) {
      const spread = 0.0130;
      const quotaFissa = 15;
      const variabili = 0.00185 + 0.0035;
      const prezzoKwh = prezzoIndicizzatoKwh(pun, spread, variabili, tensione, true);
      return resultRow("CEI PARTNER (> 30.000 kWh)", prezzoKwh * consumo, quotaFissa);
    }

    function calcolaCeiFlex(consumo, pun, tensione) {
      const spread = 0.0090;
      const quotaFissa = 15;
      const variabili = 0.002 + 0.0035;
      const prezzoKwh = prezzoIndicizzatoKwh(pun, spread, variabili, tensione, true);
      return resultRow("CEI FLEX (> 30.000 kWh)", prezzoKwh * consumo, quotaFissa);
    }

    function calcolaCeiPro(consumo, pun, tensione) {
      const spread = 0.0110;
      const quotaFissa = 15;
      const variabili = 0.002 + 0.0035;
      const prezzoKwh = prezzoIndicizzatoKwh(pun, spread, variabili, tensione, true);
      return resultRow("CEI PRO (> 30.000 kWh)", prezzoKwh * consumo, quotaFissa);
    }

    /***************************************************************
     * ESTRA
     ***************************************************************/
    function calcolaEstraTrendUnica(consumo, pun, tensione) {
      const spread = 0.0242;
      const quotaFissa = 168.084 / 12;

      // Trend: PUN con perdite + spread + GO + disp + capacità
      const prezzoKwh = prezzoIndicizzatoKwh(pun, spread + ESTRA_GO_KWH, 0.0, tensione, true);
      return resultRow("ESTRA TREND UNICA VARIABILE", prezzoKwh * consumo, quotaFissa);
    }

    function calcolaEstraRelaxUnica(consumo, tensione) {
      // Relax: prezzo fisso energia + GO + disp + capacità
      // Nota: se la fissa è “al lordo perdite” NON va moltiplicata.
      const prezzoFissoEnergia = 0.143;
      const quotaFissa = 168.084 / 12;

      const disp = DISP_KWH[tensione] ?? DISP_KWH.BT;
      const cap = CAPACITA_KWH[tensione] ?? CAPACITA_KWH.BT;

      const prezzoKwhTot = prezzoFissoEnergia + ESTRA_GO_KWH + disp + cap;
      return resultRow("ESTRA RELAX UNICA FISSA", prezzoKwhTot * consumo, quotaFissa);
    }

    /***************************************************************
     * RENDER
     ***************************************************************/
    function renderTable(tbody, offerte) {
      tbody.innerHTML = "";
      offerte.forEach(offerta => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${offerta.nome}</td><td>${offerta.costoMateriaPrima}</td><td>${offerta.quotaFissa}</td><td>${offerta.totale}</td>`;
        tbody.appendChild(row);
      });
    }

    function calcolaTutteLeOfferte() {
      const consumoMensile = parseFloat(document.getElementById('consumo').value);
      const pun = parseFloat(document.getElementById('pun').value);
      const tensione = getTensione();

      if (Number.isNaN(consumoMensile) || consumoMensile < 0) {
        alert("Inserisci un consumo mensile valido (kWh).");
        return;
      }
      if (Number.isNaN(pun) || pun < 0) {
        alert("Inserisci un PUN valido (€/kWh).");
        return;
      }

      const ceiSuperiori = [
        calcolaCeiPartner(consumoMensile, pun, tensione),
        calcolaCeiPro(consumoMensile, pun, tensione),
        calcolaCeiFlex(consumoMensile, pun, tensione)
      ];

      const ceiInferiori = [
        calcolaCeiReflex(consumoMensile, pun, tensione),
        calcolaCanon(consumoMensile, pun, tensione),
        calcolaVision(consumoMensile, pun, tensione)
      ];

      const altre = [
        calcolaEstraTrendUnica(consumoMensile, pun, tensione),
        calcolaEstraRelaxUnica(consumoMensile, tensione)
      ];

      renderTable(document.querySelector('#tabella-cei-superiore tbody'), ceiSuperiori);
      renderTable(document.querySelector('#tabella-cei-inferiore tbody'), ceiInferiori);
      renderTable(document.querySelector('#tabella-altre tbody'), altre);
    }

    window.onload = calcolaTutteLeOfferte;
  </script>
</body>
</html>
