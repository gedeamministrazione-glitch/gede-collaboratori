<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GEDE COMPARA</title>
  <link rel="stylesheet" href="../styles.css" />

  <style>
    /* Layout base */
    body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#0b1220; color:#fff; }

    .app {
      display:flex;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar {
      width:240px;
      background:#071733;
      padding:22px 16px;
      box-sizing:border-box;
    }
    .sidebar h1 {
      font-size:18px;
      margin:0 0 18px 0;
      letter-spacing:0.5px;
    }
    .menu a {
      display:block;
      padding:12px 14px;
      border-radius:10px;
      color:#fff;
      text-decoration:none;
      margin-bottom:10px;
      background:rgba(255,255,255,0.06);
      transition:0.15s;
      font-weight:600;
    }
    .menu a:hover {
      background:rgba(255,255,255,0.12);
    }

    /* Main */
    .main {
      flex:1;
      padding:24px;
      box-sizing:border-box;
    }

    .card {
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:18px;
      margin-bottom:18px;
    }

    .card h2 {
      margin:0 0 12px 0;
      font-size:18px;
    }

    label {
      display:block;
      margin:10px 0 6px;
      font-weight:700;
      font-size:14px;
      color:rgba(255,255,255,0.92);
    }

    input, select {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.15);
      background:rgba(0,0,0,0.25);
      color:#fff;
      font-size:14px;
      box-sizing:border-box;
    }

    button {
      margin-top:14px;
      padding:11px 14px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      background:#2563eb;
      color:#fff;
      font-size:14px;
      transition:0.15s;
    }
    button:hover { background:#1d4ed8; }

    .note {
      font-size:13px;
      color:rgba(255,255,255,0.75);
      margin-top:10px;
      line-height:1.4;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      overflow:hidden;
      border-radius:12px;
    }

    th, td {
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      text-align:left;
      font-size:14px;
    }

    th {
      background:rgba(255,255,255,0.10);
      font-weight:800;
    }

    tr:hover td {
      background:rgba(255,255,255,0.05);
    }

    .badge {
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.22);
      border:1px solid rgba(37,99,235,0.35);
      color:#c7d2fe;
      font-size:12px;
      font-weight:700;
    }

    .grid2 {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:900px){
      .app{ flex-direction:column; }
      .sidebar{ width:100%; }
      .grid2{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h1>GEDE COMPARA</h1>

    <div class="menu">
      <a href="#business-gas">Business Gas</a>
      <a href="#business-luce">Business Luce</a>
      <a href="#domestico-gas">Domestico Gas</a>
      <a href="#domestico-luce">Domestico Luce</a>
    </div>

    <div class="note">
      Dati presi da Google Sheet (CSV pubblicati).<br>
      Il comparatore mostra solo la componente vendita (energia + quote vendita).<br>
      Esclusi costi ARERA, trasporto, oneri, imposte, IVA.
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- BUSINESS GAS -->
    <section id="business-gas" class="card">
      <h2>Business Gas</h2>

      <div class="grid2">
        <div>
          <label>Consumo mensile (Smc)</label>
          <input type="number" id="bg-consumo" value="416.67" step="0.01" min="0" />
        </div>

        <div>
          <label>Indice Gas (€/Smc) <span class="badge">PSV / ICIS</span></label>
          <input type="number" id="bg-psv" value="0.40" step="0.0001" min="0" />
        </div>
      </div>

      <button onclick="runBusinessGas()">Calcola Business Gas</button>

      <div class="note">
        Nota: l’indice gas è inserito manualmente. I risultati sono una stima mensile.
      </div>

      <div id="bg-results"></div>
    </section>


    <!-- BUSINESS LUCE -->
    <section id="business-luce" class="card">
      <h2>Business Luce</h2>

      <div class="grid2">
        <div>
          <label>Consumo mensile (kWh)</label>
          <input type="number" id="bl-consumo" value="833" step="1" min="0" />
        </div>

        <div>
          <label>PUN monorario (€/kWh) <span class="badge">puro</span></label>
          <input type="number" id="bl-pun" value="0.12" step="0.0001" min="0" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Tensione</label>
        <select id="bl-tensione">
          <option value="BT" selected>BT - Bassa Tensione</option>
          <option value="MT">MT - Media Tensione</option>
        </select>
      </div>

      <button onclick="runBusinessLuce()">Calcola Business Luce</button>

      <div class="note">
        Perdite: BT 10% (×1,10) — MT 3,8% (×1,038).<br>
        Dispacciamento e capacità sono letti da rules.js.
      </div>

      <div id="bl-results"></div>
    </section>


    <!-- DOMESTICO GAS -->
    <section id="domestico-gas" class="card">
      <h2>Domestico Gas</h2>

      <div class="grid2">
        <div>
          <label>Consumo mensile (Smc)</label>
          <input type="number" id="dg-consumo" value="100" step="0.01" min="0" />
        </div>

        <div>
          <label>Indice Gas (€/Smc) <span class="badge">PSV / ICIS</span></label>
          <input type="number" id="dg-psv" value="0.40" step="0.0001" min="0" />
        </div>
      </div>

      <button onclick="runDomesticoGas()">Calcola Domestico Gas</button>

      <div id="dg-results"></div>
    </section>


    <!-- DOMESTICO LUCE -->
    <section id="domestico-luce" class="card">
      <h2>Domestico Luce</h2>

      <div class="grid2">
        <div>
          <label>Consumo mensile (kWh)</label>
          <input type="number" id="dl-consumo" value="225" step="1" min="0" />
        </div>

        <div>
          <label>PUN (€/kWh) <span class="badge">puro</span></label>
          <input type="number" id="dl-pun" value="0.12" step="0.0001" min="0" />
        </div>
      </div>

      <button onclick="runDomesticoLuce()">Calcola Domestico Luce</button>

      <div id="dl-results"></div>
    </section>

  </main>
</div>

<script src="../offers.js"></script>
<script src="../rules.js"></script>

<script>
  // ============================
  // Helpers
  // ============================
  function eur(n){
    const x = Number(n);
    if(!isFinite(x)) return "0,00";
    return x.toFixed(2).replace(".", ",");
  }

  function renderTable(containerId, title, rows){
    const el = document.getElementById(containerId);
    if(!rows || rows.length === 0){
      el.innerHTML = "<p class='note'>Nessuna offerta trovata.</p>";
      return;
    }

    let html = `<h3 style="margin:14px 0 8px 0;">${title}</h3>`;
    html += `<table>
      <thead>
        <tr>
          <th>Offerta</th>
          <th>Materia Prima (€)</th>
          <th>Quota Fissa (€)</th>
          <th>Variabili (€)</th>
          <th>Totale (€)</th>
        </tr>
      </thead>
      <tbody>`;

    rows.forEach(r=>{
      html += `<tr>
        <td>${r.nome}</td>
        <td>€ ${eur(r.costoMateriaPrima)}</td>
        <td>€ ${eur(r.quotaFissa)}</td>
        <td>€ ${eur(r.costiVariabili)}</td>
        <td><b>€ ${eur(r.totale)}</b></td>
      </tr>`;
    });

    html += `</tbody></table>`;
    el.innerHTML = html;
  }

  function calcIndicizzata(consumo, indice, spread, quotaFissa, variabiliUnit){
    const costoMateriaPrima = consumo * (indice + spread);
    const costiVariabili = consumo * (variabiliUnit || 0);
    const totale = costoMateriaPrima + quotaFissa + costiVariabili;
    return { costoMateriaPrima, quotaFissa, costiVariabili, totale };
  }

  // ============================
  // BUSINESS GAS
  // ============================
  async function runBusinessGas(){
    const consumo = parseFloat(document.getElementById("bg-consumo").value) || 0;
    const psv = parseFloat(document.getElementById("bg-psv").value) || 0;

    const offers = await window.GEDE_OFFERS.getOffers("business_gas");
    const outGT = [];
    const outLT = [];
    const outESTRA = [];

    offers.forEach(o=>{
      // regola divisione: CEI > 10.000 Smc oppure < 10.000
      const isCei = (o.brand || "").toLowerCase() === "cei";
      const isEstra = (o.brand || "").toLowerCase() === "estra";

      const r = calcIndicizzata(
        consumo,
        psv,
        o.spread || 0,
        o.quotaFissaMensile || 0,
        o.variabiliUnit || 0
      );

      const row = { nome:o.nome, ...r };

      if(isCei){
        if(o.segment === "GT") outGT.push(row);
        else outLT.push(row);
      } else if(isEstra){
        outESTRA.push(row);
      }
    });

    renderTable("bg-results", "Risultati Business Gas", [...outGT, ...outLT, ...outESTRA]);
  }

  // ============================
  // BUSINESS LUCE
  // ============================
  async function runBusinessLuce(){
    const consumo = parseFloat(document.getElementById("bl-consumo").value) || 0;
    const pun = parseFloat(document.getElementById("bl-pun").value) || 0;
    const tensione = document.getElementById("bl-tensione").value || "BT";

    const rules = await window.GEDE_RULES.getRules();
    const loss = rules.loss_multiplier?.[tensione] ?? 1.10;
    const disp = rules.disp_kwh?.[tensione] ?? 0.01078;
    const cap  = rules.capacita_kwh?.[tensione] ?? 0.009008;

    const offers = await window.GEDE_OFFERS.getOffers("business_luce");

    const rows = offers.map(o=>{
      const punEff = pun * loss;

      const prezzoKwh =
        punEff +
        (o.spread || 0) +
        (o.extraVariabiliKwh || 0) +
        disp +
        cap +
        (o.go_kwh || 0); // se GO è obbligatoria

      const costoMateriaPrima = consumo * prezzoKwh;
      const quotaFissa = o.quotaFissaMensile || 0;
      const costiVariabili = 0;
      const totale = costoMateriaPrima + quotaFissa;

      return { nome:o.nome, costoMateriaPrima, quotaFissa, costiVariabili, totale };
    });

    renderTable("bl-results", "Risultati Business Luce", rows);
  }

  // ============================
  // DOMESTICO GAS
  // ============================
  async function runDomesticoGas(){
    const consumo = parseFloat(document.getElementById("dg-consumo").value) || 0;
    const psv = parseFloat(document.getElementById("dg-psv").value) || 0;

    const offers = await window.GEDE_OFFERS.getOffers("domestico_gas");

    const rows = offers.map(o=>{
      // Se è prezzo fisso gas
      if(o.prezzoFisso){
        const costoMateriaPrima = consumo * o.prezzoFisso;
        const quotaFissa = o.quotaFissaMensile || 0;
        const costiVariabili = consumo * (o.variabiliUnit || 0);
        const totale = costoMateriaPrima + quotaFissa + costiVariabili - (o.scontoMensile || 0);
        return { nome:o.nome, costoMateriaPrima, quotaFissa, costiVariabili, totale };
      }

      // Indicizzata
      const r = calcIndicizzata(consumo, psv, o.spread || 0, o.quotaFissaMensile || 0, o.variabiliUnit || 0);
      r.totale = r.totale - (o.scontoMensile || 0);
      return { nome:o.nome, ...r };
    });

    renderTable("dg-results", "Risultati Domestico Gas", rows);
  }

  // ============================
  // DOMESTICO LUCE
  // ============================
  async function runDomesticoLuce(){
    const consumo = parseFloat(document.getElementById("dl-consumo").value) || 0;
    const pun = parseFloat(document.getElementById("dl-pun").value) || 0;

    const rules = await window.GEDE_RULES.getRules();
    const loss = rules.loss_multiplier?.BT ?? 1.10;
    const disp = rules.disp_kwh?.BT ?? 0.01078;
    const cap  = rules.capacita_kwh?.BT ?? 0.009008;

    const offers = await window.GEDE_OFFERS.getOffers("domestico_luce");

    const rows = offers.map(o=>{
      // fissa
      if(o.prezzoFisso){
        const prezzoKwhTot = o.prezzoFisso + disp + cap + (o.go_kwh || 0);
        const costoMateriaPrima = consumo * prezzoKwhTot;
        const quotaFissa = o.quotaFissaMensile || 0;
        const costiVariabili = 0;
        const totale = costoMateriaPrima + quotaFissa - (o.scontoMensile || 0);
        return { nome:o.nome, costoMateriaPrima, quotaFissa, costiVariabili, totale };
      }

      // indicizzata
      const punEff = pun * loss;
      const prezzoKwhTot =
        punEff +
        (o.spread || 0) +
        disp +
        cap +
        (o.go_kwh || 0);

      const costoMateriaPrima = consumo * prezzoKwhTot;
      const quotaFissa = o.quotaFissaMensile || 0;
      const costiVariabili = 0;
      const totale = costoMateriaPrima + quotaFissa - (o.scontoMensile || 0);

      return { nome:o.nome, costoMateriaPrima, quotaFissa, costiVariabili, totale };
    });

    renderTable("dl-results", "Risultati Domestico Luce", rows);
  }

  // Auto-run all on load (così vedi subito se carica CSV)
  window.addEventListener("load", ()=>{
    runBusinessGas();
    runBusinessLuce();
    runDomesticoGas();
    runDomesticoLuce();
  });
</script>

</body>
</html>
